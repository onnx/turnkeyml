# This workflow will install Python dependencies, run tests and lint with a single version of Python
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python

name: Test Lemonade Hybrid with Finetuned Model on OGA 🌩️

on:
  push:
    branches: ["main"]
  pull_request:
    branches:
      - '**'

permissions:
  contents: read

jobs:
  make-hybrid-oga-finetuned-lemonade:
    env:
        LEMONADE_CI_MODE: "True"
    runs-on: [stx, miniforge]
    steps:
      - uses: actions/checkout@v3
      - name: Set up Miniconda with 64-bit Python
        shell: PowerShell
        run: |
          # Make sure the system-level python is clean
          Remove-Item -Path "C:\\windows\\system32\\config\\systemprofile\\AppData\\Roaming\\Python" -Recurse -Force 
          
          $ErrorActionPreference = "Stop"
          conda create -p .\lemon-hybrid-finetuned-ci python=3.10 -y
          conda init
      - name: Install dependencies
        shell: PowerShell
        env:
          OGA_TOKEN: "${{ secrets.OGA_TOKEN }}"
        run: |
          $ErrorActionPreference = "Stop"
          conda activate .\lemon-hybrid-finetuned-ci
          python -m pip install --upgrade pip
          conda install pylint
          python -m pip check
          pip install -e .[llm-oga-hybrid]
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

          # Install OGA support for Hybrid
          # This test uses the token env var, while the npu test uses the --token option
          lemonade-install --ryzenai hybrid -y --build-model
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

          $cwd = (Get-Item .\).FullName
          echo "HF_HOME=$cwd\hf-cache" >> $Env:GITHUB_ENV
      - name: Run lemonade Hybrid OGA Finetuned Model tests
        shell: PowerShell
        env:
          HF_HOME: "${{ env.HF_HOME }}"
          LEMONADE_CACHE_DIR: ".\\ci-cache"
        run: |
          $ErrorActionPreference = "Stop"
          conda activate .\lemon-hybrid-finetuned-ci

          # Test CLI
          lemonade -m -i aigdat/GreyBox-Unsloth-Llama-3.2-1b-awq-g128-asym oga-load --device hybrid --dtype int4 llm-prompt -p "Alice and Bob" --max-new-tokens 10
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }